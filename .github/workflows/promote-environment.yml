name: Promote Between Environments

on:
  workflow_dispatch:
    inputs:
      source_environment:
        description: 'Source environment'
        required: true
        type: choice
        options:
          - dev
          - qa
          - uat1
          - uat2
          - uat3
          - staging
      target_environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - qa
          - uat1
          - uat2
          - uat3
          - staging
          - live
      image_tag:
        description: 'Image tag to promote (leave empty for latest from source)'
        required: false
        type: string

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com

jobs:
  validate:
    name: Validate Promotion Path
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.validate.outputs.valid }}
    steps:
      - name: Validate promotion path
        id: validate
        run: |
          SOURCE="${{ inputs.source_environment }}"
          TARGET="${{ inputs.target_environment }}"

          # Define valid promotion paths
          case "$SOURCE-$TARGET" in
            dev-qa|qa-uat1|qa-uat2|qa-uat3|uat1-staging|uat2-staging|uat3-staging|staging-live)
              echo "valid=true" >> $GITHUB_OUTPUT
              echo "Valid promotion: $SOURCE -> $TARGET"
              ;;
            *)
              echo "valid=false" >> $GITHUB_OUTPUT
              echo "::error::Invalid promotion path: $SOURCE -> $TARGET"
              echo "Valid paths: dev->qa, qa->uat*, uat*->staging, staging->live"
              exit 1
              ;;
          esac

  get-tag:
    name: Get Image Tag
    needs: validate
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.get-tag.outputs.tag }}
    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-ecr
          aws-region: ${{ env.AWS_REGION }}

      - name: Get latest tag from source
        id: get-tag
        run: |
          if [[ -n "${{ inputs.image_tag }}" ]]; then
            echo "tag=${{ inputs.image_tag }}" >> $GITHUB_OUTPUT
          else
            # Get latest tag from source environment
            TAG=$(aws ecr describe-images \
              --repository-name quckapp/api \
              --query 'sort_by(imageDetails,& imagePushedAt)[-1].imageTags[0]' \
              --output text \
              --filter tagStatus=TAGGED)
            echo "tag=$TAG" >> $GITHUB_OUTPUT
          fi

  promote:
    name: Promote to ${{ inputs.target_environment }}
    needs: [validate, get-tag]
    runs-on: ubuntu-latest
    environment: ${{ inputs.target_environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-eks-${{ inputs.target_environment }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4

      - name: Setup Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Update kubeconfig
        run: |
          CLUSTER_NAME="quckapp-${{ inputs.target_environment }}"
          if [[ "${{ inputs.target_environment }}" == "live" ]]; then
            CLUSTER_NAME="quckapp-prod"
          fi
          aws eks update-kubeconfig --name $CLUSTER_NAME --region ${{ env.AWS_REGION }}

      - name: Tag images for target environment
        run: |
          # Re-tag images for target environment
          aws ecr get-login-password | docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}

          SOURCE_TAG="${{ needs.get-tag.outputs.image_tag }}"
          TARGET_TAG="${{ inputs.target_environment }}-${{ github.run_number }}"

          for repo in api worker; do
            docker pull ${{ env.ECR_REGISTRY }}/quckapp/${repo}:${SOURCE_TAG}
            docker tag ${{ env.ECR_REGISTRY }}/quckapp/${repo}:${SOURCE_TAG} \
                       ${{ env.ECR_REGISTRY }}/quckapp/${repo}:${TARGET_TAG}
            docker push ${{ env.ECR_REGISTRY }}/quckapp/${repo}:${TARGET_TAG}
          done

          echo "IMAGE_TAG=${TARGET_TAG}" >> $GITHUB_ENV

      - name: Update Kustomize images
        run: |
          cd infrastructure/k8s/overlays/${{ inputs.target_environment }}
          kustomize edit set image \
            quckapp/api=${{ env.ECR_REGISTRY }}/quckapp/api:${{ env.IMAGE_TAG }} \
            quckapp/worker=${{ env.ECR_REGISTRY }}/quckapp/worker:${{ env.IMAGE_TAG }}

      - name: Deploy to target
        run: |
          kustomize build infrastructure/k8s/overlays/${{ inputs.target_environment }} | kubectl apply -f -

      - name: Wait for rollout
        run: |
          PREFIX="${{ inputs.target_environment }}"
          NAMESPACE="quckapp-${{ inputs.target_environment }}"

          kubectl rollout status deployment/${PREFIX}-quckapp-api -n ${NAMESPACE} --timeout=600s
          kubectl rollout status deployment/${PREFIX}-quckapp-worker -n ${NAMESPACE} --timeout=600s

      - name: Summary
        run: |
          echo "## Promotion Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Source | ${{ inputs.source_environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Target | ${{ inputs.target_environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | ${{ env.IMAGE_TAG }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Success |" >> $GITHUB_STEP_SUMMARY
