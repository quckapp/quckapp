name: Kubernetes Deployment

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'infrastructure/k8s/**'
      - 'infrastructure/helm/**'
      - 'services/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - qa
          - staging
          - prod
      image_tag:
        description: 'Image tag to deploy (default: git SHA)'
        required: false
        type: string

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  # Determine config
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      namespace: ${{ steps.env.outputs.namespace }}
      values-file: ${{ steps.env.outputs.values_file }}
      image-tag: ${{ steps.env.outputs.image_tag }}
    steps:
      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ inputs.environment }}"
            TAG="${{ inputs.image_tag }}"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV="staging"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            ENV="dev"
          else
            ENV="dev"
          fi

          TAG="${TAG:-${{ github.sha }}}"

          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "namespace=quckapp-$ENV" >> $GITHUB_OUTPUT
          echo "values_file=values-${ENV/prod/production}.yaml" >> $GITHUB_OUTPUT
          echo "image_tag=$TAG" >> $GITHUB_OUTPUT

  # Deploy using Helm
  deploy:
    name: Deploy to ${{ needs.setup.outputs.environment }}
    needs: setup
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-eks-${{ needs.setup.outputs.environment }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'

      - name: Update kubeconfig
        run: |
          CLUSTER_NAME="quckapp-${{ needs.setup.outputs.environment }}"
          if [[ "${{ needs.setup.outputs.environment }}" == "prod" ]]; then
            CLUSTER_NAME="quckapp-prod"
          fi
          aws eks update-kubeconfig --name $CLUSTER_NAME --region ${{ env.AWS_REGION }}

      - name: Add Helm repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add elastic https://helm.elastic.co
          helm repo add minio https://charts.min.io/
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo update

      - name: Build Helm dependencies
        run: helm dependency build infrastructure/helm/quckapp

      - name: Create namespace
        run: kubectl create namespace ${{ needs.setup.outputs.namespace }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy with Helm
        run: |
          helm upgrade --install quckapp infrastructure/helm/quckapp \
            --namespace ${{ needs.setup.outputs.namespace }} \
            --values infrastructure/helm/quckapp/${{ needs.setup.outputs.values-file }} \
            --set global.imageRegistry=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }} \
            --set global.imageTag=${{ needs.setup.outputs.image-tag }} \
            --set global.imagePullPolicy=Always \
            --timeout 15m \
            --wait \
            --atomic

      - name: Verify deployment
        run: |
          kubectl rollout status deployment -n ${{ needs.setup.outputs.namespace }} --timeout=10m

      - name: Deployment summary
        run: |
          echo "### K8s Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ needs.setup.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Namespace | ${{ needs.setup.outputs.namespace }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | ${{ needs.setup.outputs.image-tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Pod Status" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          kubectl get pods -n ${{ needs.setup.outputs.namespace }} >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
