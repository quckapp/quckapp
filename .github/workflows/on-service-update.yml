# =============================================================================
# On Service Update - Triggered by per-service CI
# =============================================================================
# When a service CI pushes a new image to ACR, it sends a repository_dispatch
# event to this repo. This workflow:
# 1. Updates the submodule ref to the new commit
# 2. Triggers the Azure DevOps CD pipeline
# =============================================================================

name: On Service Update

on:
  repository_dispatch:
    types: [service-image-pushed]

permissions:
  contents: write

concurrency:
  group: submodule-update
  cancel-in-progress: false

jobs:
  update-submodule:
    name: Update ${{ github.event.client_payload.service }} submodule
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update submodule ref
        run: |
          SERVICE="${{ github.event.client_payload.service }}"
          SHA="${{ github.event.client_payload.sha }}"

          echo "Updating services/$SERVICE to $SHA"
          cd services/$SERVICE
          git fetch origin
          git checkout $SHA
          cd ../..

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add services/$SERVICE
          git commit -m "chore: update $SERVICE submodule to ${SHA:0:7}" || echo "No changes to commit"
          git push

      - name: Summary
        run: |
          echo "### Submodule Updated" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Service | ${{ github.event.client_payload.service }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | ${{ github.event.client_payload.tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit SHA | ${{ github.event.client_payload.sha }} |" >> $GITHUB_STEP_SUMMARY

  trigger-azure-cd:
    name: Trigger Azure DevOps CD
    needs: update-submodule
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Azure DevOps Pipeline
        run: |
          SERVICE="${{ github.event.client_payload.service }}"
          TAG="${{ github.event.client_payload.tag }}"

          echo "Triggering Azure DevOps CD for $SERVICE:$TAG"

          curl -s -X POST \
            -H "Authorization: Basic $(echo -n ":${{ secrets.AZURE_DEVOPS_PAT }}" | base64)" \
            -H "Content-Type: application/json" \
            -d "{
              \"templateParameters\": {
                \"serviceName\": \"$SERVICE\",
                \"imageTag\": \"$TAG\",
                \"startEnvironment\": \"dev\"
              }
            }" \
            "https://dev.azure.com/AtomiverX/QuckApp/_apis/pipelines/${{ vars.AZURE_CD_PIPELINE_ID }}/runs?api-version=7.1" \
            -o response.json

          echo "Azure DevOps response:"
          cat response.json | python3 -c "import sys,json; d=json.load(sys.stdin); print(f'Pipeline Run ID: {d.get(\"id\", \"N/A\")}')" 2>/dev/null || cat response.json
