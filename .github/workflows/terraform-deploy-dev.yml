# =============================================================================
# Terraform Deploy - Dev Environment
# =============================================================================
# Deploys infrastructure changes to the dev environment:
# - Triggered on merge to develop branch
# - Or manually triggered
# - Applies Terraform changes automatically
# =============================================================================

name: Terraform Deploy Dev

on:
  push:
    branches:
      - develop
    paths:
      - 'infrastructure/terraform/environments/dev/**'
      - 'infrastructure/terraform/modules/**'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      action:
        description: 'Terraform action to perform'
        required: true
        default: 'apply'
        type: choice
        options:
          - plan
          - apply
          - destroy
      confirm_destroy:
        description: 'Type "destroy" to confirm destruction'
        required: false
        type: string

permissions:
  id-token: write
  contents: read
  issues: write

env:
  TF_VERSION: '1.6.0'
  AWS_REGION: 'us-east-1'
  ENVIRONMENT: 'dev'
  TF_WORKING_DIR: 'infrastructure/terraform/environments/dev'

jobs:
  # ===========================================================================
  # Terraform Plan
  # ===========================================================================
  plan:
    name: Plan
    runs-on: ubuntu-latest
    outputs:
      plan_exit_code: ${{ steps.plan.outputs.exitcode }}
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Plan
        id: plan
        run: |
          set +e
          terraform plan -no-color -out=tfplan \
            -var-file="dev.tfvars" \
            -detailed-exitcode \
            2>&1 | tee plan_output.txt
          echo "exitcode=$?" >> $GITHUB_OUTPUT

      - name: Upload Plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-dev
          path: |
            ${{ env.TF_WORKING_DIR }}/tfplan
            ${{ env.TF_WORKING_DIR }}/plan_output.txt
          retention-days: 1

  # ===========================================================================
  # Terraform Apply
  # ===========================================================================
  apply:
    name: Apply
    runs-on: ubuntu-latest
    needs: plan
    # Apply if: plan has changes (exit code 2) and action is apply or push event
    if: |
      needs.plan.outputs.plan_exit_code == '2' &&
      (github.event_name == 'push' || github.event.inputs.action == 'apply')
    environment:
      name: dev
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-dev
          path: ${{ env.TF_WORKING_DIR }}

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        id: apply
        run: |
          terraform apply -no-color -auto-approve tfplan \
            2>&1 | tee apply_output.txt

      - name: Post Apply Summary
        if: always()
        run: |
          echo "## Terraform Apply - Dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.apply.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "<details>" >> $GITHUB_STEP_SUMMARY
          echo "<summary>Apply Output</summary>" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -100 apply_output.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "</details>" >> $GITHUB_STEP_SUMMARY

      - name: Notify on Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Terraform Apply Failed - Dev Environment`,
              body: `Terraform apply failed for the dev environment.\n\n**Workflow:** ${context.workflow}\n**Run:** ${context.runId}\n**Commit:** ${context.sha}\n\n[View Workflow Run](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
              labels: ['infrastructure', 'bug']
            });

  # ===========================================================================
  # Terraform Destroy (Manual Only)
  # ===========================================================================
  destroy:
    name: Destroy
    runs-on: ubuntu-latest
    needs: plan
    if: |
      github.event_name == 'workflow_dispatch' &&
      github.event.inputs.action == 'destroy' &&
      github.event.inputs.confirm_destroy == 'destroy'
    environment:
      name: dev-destroy
    defaults:
      run:
        working-directory: ${{ env.TF_WORKING_DIR }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DEV }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform Init
        run: terraform init

      - name: Terraform Destroy
        run: |
          terraform destroy -no-color -auto-approve \
            -var-file="dev.tfvars"

  # ===========================================================================
  # Output Summary
  # ===========================================================================
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [plan, apply]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## Terraform Deployment - Dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Plan | ${{ needs.plan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Apply | ${{ needs.apply.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
