name: Kubernetes Deploy All Environments

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - dev
          - qa
          - uat1
          - uat2
          - uat3
          - staging
          - live
      image_tag:
        description: 'Image tag to deploy'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-east-1
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-eks-${{ inputs.environment }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'

      - name: Update kubeconfig
        run: |
          CLUSTER_NAME="quckapp-${{ inputs.environment }}"
          if [[ "${{ inputs.environment }}" == "live" ]]; then
            CLUSTER_NAME="quckapp-prod"
          fi
          aws eks update-kubeconfig --name $CLUSTER_NAME --region ${{ env.AWS_REGION }}

      - name: Determine values file
        id: values
        run: |
          ENV="${{ inputs.environment }}"
          case $ENV in
            live) VALUES_FILE="values-production.yaml" ;;
            *)    VALUES_FILE="values-${ENV}.yaml" ;;
          esac
          NAMESPACE="quckapp-${ENV}"
          echo "values_file=$VALUES_FILE" >> $GITHUB_OUTPUT
          echo "namespace=$NAMESPACE" >> $GITHUB_OUTPUT

      - name: Add Helm repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add elastic https://helm.elastic.co
          helm repo add minio https://charts.min.io/
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo update

      - name: Build Helm dependencies
        run: helm dependency build infrastructure/helm/quckapp

      - name: Create namespace
        run: kubectl create namespace ${{ steps.values.outputs.namespace }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy with Helm
        run: |
          helm upgrade --install quckapp infrastructure/helm/quckapp \
            --namespace ${{ steps.values.outputs.namespace }} \
            --values infrastructure/helm/quckapp/${{ steps.values.outputs.values_file }} \
            --set global.imageRegistry=${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }} \
            --set global.imageTag=${{ inputs.image_tag }} \
            --set global.imagePullPolicy=Always \
            --timeout 15m \
            --wait \
            --atomic

      - name: Verify deployment
        run: |
          NAMESPACE="${{ steps.values.outputs.namespace }}"
          echo "=== Pods ==="
          kubectl get pods -n ${NAMESPACE}
          echo ""
          echo "=== Services ==="
          kubectl get svc -n ${NAMESPACE}
          echo ""
          echo "=== Ingress ==="
          kubectl get ingress -n ${NAMESPACE}

      - name: Run smoke tests
        if: inputs.environment == 'staging' || inputs.environment == 'live'
        run: |
          NAMESPACE="${{ steps.values.outputs.namespace }}"
          kubectl run smoke-test --rm -it --restart=Never \
            --image=curlimages/curl:latest \
            -n ${NAMESPACE} \
            -- curl -sf "http://backend-gateway:3000/health" || echo "Smoke test: gateway not reachable via ClusterIP"
          echo "Smoke tests completed!"

      - name: Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Namespace | ${{ steps.values.outputs.namespace }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | ${{ inputs.image_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Values File | ${{ steps.values.outputs.values_file }} |" >> $GITHUB_STEP_SUMMARY
