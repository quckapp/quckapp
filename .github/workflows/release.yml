# QuikApp Release Workflow
# Creates releases with changelog generation

name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.2.3)'
        required: true
      prerelease:
        description: 'Is this a pre-release?'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  packages: write
  pull-requests: read

jobs:
  # ==========================================================================
  # Create Release
  # ==========================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.version.outputs.version }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${{ github.ref_name }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v6
        with:
          configuration: .github/changelog-config.json
          toTag: ${{ steps.version.outputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## What's Changed

            ${{ steps.changelog.outputs.changelog }}

            ## Installation

            ### Docker Compose
            ```bash
            git checkout ${{ steps.version.outputs.version }}
            docker-compose up -d
            ```

            ### Kubernetes (Helm)
            ```bash
            helm repo add quikapp https://quikapp.github.io/quikapp
            helm repo update
            helm install quikapp quikapp/quikapp --version ${{ steps.version.outputs.version }}
            ```

            ### Docker Images
            All service images are available at:
            ```
            ghcr.io/${{ github.repository }}/<service-name>:${{ steps.version.outputs.version }}
            ```

            ## Full Changelog
            https://github.com/${{ github.repository }}/compare/....${{ steps.version.outputs.version }}
          draft: false
          prerelease: ${{ github.event.inputs.prerelease || false }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==========================================================================
  # Build and Push All Images
  # ==========================================================================
  build-images:
    name: Build Images
    needs: release
    uses: ./.github/workflows/docker-build.yml
    with:
      service: all
      tag: ${{ needs.release.outputs.version }}
      push: true
    permissions:
      contents: read
      packages: write

  # ==========================================================================
  # Release Helm Chart
  # ==========================================================================
  helm-release:
    name: Release Helm Chart
    needs: release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Helm
        uses: azure/setup-helm@v3
        with:
          version: 'v3.13.0'

      - name: Update chart version
        run: |
          VERSION="${{ needs.release.outputs.version }}"
          VERSION="${VERSION#v}"  # Remove 'v' prefix

          sed -i "s/^version:.*/version: $VERSION/" infrastructure/helm/quikapp/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"$VERSION\"/" infrastructure/helm/quikapp/Chart.yaml

      - name: Add Helm repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add elastic https://helm.elastic.co
          helm repo add minio https://charts.min.io/
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo add jaegertracing https://jaegertracing.github.io/helm-charts
          helm repo add open-telemetry https://open-telemetry.github.io/opentelemetry-helm-charts
          helm repo update

      - name: Package chart
        run: |
          helm dependency build infrastructure/helm/quikapp
          helm package infrastructure/helm/quikapp

      - name: Upload chart to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.release.outputs.version }}
          files: quikapp-*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push chart to OCI registry
        run: |
          helm push quikapp-*.tgz oci://ghcr.io/${{ github.repository }}/charts

  # ==========================================================================
  # Notify
  # ==========================================================================
  notify:
    name: Notify Release
    needs: [release, build-images, helm-release]
    runs-on: ubuntu-latest

    steps:
      - name: Slack notification
        if: vars.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "ðŸš€ QuikApp ${{ needs.release.outputs.version }} Released!",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸš€ QuikApp ${{ needs.release.outputs.version }} Released!"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "A new version of QuikApp has been released. Check out the release notes for details."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Release"
                      },
                      "url": "https://github.com/${{ github.repository }}/releases/tag/${{ needs.release.outputs.version }}"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ vars.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
