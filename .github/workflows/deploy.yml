# QuckApp Deploy Pipeline
# Builds and deploys all services to AWS ECS
# Replaces old 3-service deploy with full microservice architecture

name: Deploy to AWS

on:
  push:
    branches: [main, staging]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: choice
        options:
          - staging
          - production

env:
  AWS_REGION: us-east-1
  ECR_REGISTRY: ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com

jobs:
  # ============================================
  # Determine Environment
  # ============================================
  setup:
    name: Setup
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      cluster: ${{ steps.env.outputs.cluster }}
    steps:
      - name: Determine environment
        id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ inputs.environment }}"
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            ENV="production"
          elif [[ "${{ github.ref }}" == "refs/heads/staging" ]]; then
            ENV="staging"
          else
            ENV="staging"
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "cluster=quckapp-$ENV" >> $GITHUB_OUTPUT

  # ============================================
  # Build & Push Docker Images
  # ============================================
  build:
    name: Build ${{ matrix.service }}
    needs: setup
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    strategy:
      fail-fast: false
      matrix:
        service:
          # NestJS
          - backend-gateway
          - notification-service
          - realtime-service
          # Spring Boot
          - auth-service
          - user-service
          - permission-service
          - audit-service
          - admin-service
          - security-service
          # Elixir
          - presence-service
          - message-service
          - call-service
          - notification-orchestrator
          - huddle-service
          - event-broadcast-service
          # Go
          - workspace-service
          - channel-service
          - thread-service
          - search-service
          - file-service
          - media-service
          - bookmark-service
          - reminder-service
          - attachment-service
          - cdn-service
          # Python
          - analytics-service
          - ml-service
          - moderation-service
          - export-service
          - integration-service
          - sentiment-service
          - insights-service
          - smart-reply-service

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: services/${{ matrix.service }}
          file: services/${{ matrix.service }}/Dockerfile
          push: true
          tags: |
            ${{ env.ECR_REGISTRY }}/quckapp/${{ matrix.service }}:${{ github.sha }}
            ${{ env.ECR_REGISTRY }}/quckapp/${{ matrix.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # Deploy to Environment
  # ============================================
  deploy:
    name: Deploy to ${{ needs.setup.outputs.environment }}
    needs: [setup, build]
    runs-on: ubuntu-latest
    environment: ${{ needs.setup.outputs.environment }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy all services to ECS
        run: |
          CLUSTER="${{ needs.setup.outputs.cluster }}"
          SERVICES=(
            backend-gateway notification-service realtime-service
            auth-service user-service permission-service audit-service admin-service security-service
            presence-service message-service call-service notification-orchestrator huddle-service event-broadcast-service
            workspace-service channel-service thread-service search-service file-service media-service
            bookmark-service reminder-service attachment-service cdn-service
            analytics-service ml-service moderation-service export-service integration-service
            sentiment-service insights-service smart-reply-service
          )
          for svc in "${SERVICES[@]}"; do
            echo "Deploying $svc..."
            aws ecs update-service \
              --cluster "$CLUSTER" \
              --service "quckapp-$svc" \
              --force-new-deployment \
              --no-cli-pager || echo "Warning: $svc deployment skipped"
          done

      - name: Wait for core services
        run: |
          CLUSTER="${{ needs.setup.outputs.cluster }}"
          aws ecs wait services-stable \
            --cluster "$CLUSTER" \
            --services quckapp-backend-gateway quckapp-auth-service quckapp-workspace-service \
            || echo "Warning: Some services may still be stabilizing"

      - name: Deployment summary
        run: |
          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ needs.setup.outputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cluster | ${{ needs.setup.outputs.cluster }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Actor | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # Notify
  # ============================================
  notify:
    name: Notify
    needs: [setup, deploy]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Slack notification
        if: vars.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "QuckApp deployed to ${{ needs.setup.outputs.environment }}! ${{ needs.deploy.result == 'success' && ':rocket:' || ':x:' }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*QuckApp ${{ needs.setup.outputs.environment }} Deployment*\nStatus: ${{ needs.deploy.result }}\nCommit: `${{ github.sha }}`\nBy: ${{ github.actor }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ vars.SLACK_WEBHOOK_URL }}
