# Load Tests Template
# Load and stress testing

parameters:
  - name: environment
    type: string
  - name: serviceName
    type: string
  - name: targetRPS
    type: number
    default: 100
  - name: duration
    type: string
    default: '5m'

steps:
  - checkout: self
    displayName: 'Checkout Repository'

  - task: AzureCLI@2
    displayName: 'Run Load Tests with k6'
    inputs:
      azureSubscription: 'QuikApp-${{ parameters.environment }}'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        BASE_URL="https://${{ parameters.serviceName }}.${{ parameters.environment }}.quikapp.io"

        echo "========================================"
        echo "Load Test Configuration"
        echo "========================================"
        echo "Target URL: $BASE_URL"
        echo "Target RPS: ${{ parameters.targetRPS }}"
        echo "Duration: ${{ parameters.duration }}"
        echo "========================================"

        # Install k6
        curl -sSL https://github.com/grafana/k6/releases/download/v0.47.0/k6-v0.47.0-linux-amd64.tar.gz | tar xz
        mv k6-v0.47.0-linux-amd64/k6 /usr/local/bin/

        # Create load test script
        cat > load-test.js << 'EOF'
        import http from 'k6/http';
        import { check, sleep } from 'k6';
        import { Rate, Trend } from 'k6/metrics';

        const errorRate = new Rate('errors');
        const latencyTrend = new Trend('latency');

        export const options = {
          scenarios: {
            constant_load: {
              executor: 'constant-arrival-rate',
              rate: __ENV.TARGET_RPS || 100,
              timeUnit: '1s',
              duration: __ENV.DURATION || '5m',
              preAllocatedVUs: 50,
              maxVUs: 200,
            },
          },
          thresholds: {
            http_req_duration: ['p(95)<500', 'p(99)<1000'],
            errors: ['rate<0.01'],
            http_req_failed: ['rate<0.01'],
          },
        };

        export default function () {
          const baseUrl = __ENV.BASE_URL;

          // Health check endpoint
          const healthRes = http.get(`${baseUrl}/health`);
          check(healthRes, {
            'health status is 200': (r) => r.status === 200,
          });
          errorRate.add(healthRes.status !== 200);
          latencyTrend.add(healthRes.timings.duration);

          // API endpoints
          const endpoints = ['/api/v1/status', '/api/v1/ping'];
          for (const endpoint of endpoints) {
            const res = http.get(`${baseUrl}${endpoint}`);
            check(res, {
              'status is 2xx': (r) => r.status >= 200 && r.status < 300,
            });
            errorRate.add(res.status >= 400);
            latencyTrend.add(res.timings.duration);
          }

          sleep(0.1);
        }

        export function handleSummary(data) {
          return {
            'load-test-results.json': JSON.stringify(data, null, 2),
          };
        }
        EOF

        # Run load test
        k6 run \
          --env BASE_URL=$BASE_URL \
          --env TARGET_RPS=${{ parameters.targetRPS }} \
          --env DURATION=${{ parameters.duration }} \
          --out json=load-test-output.json \
          load-test.js

  - task: PowerShell@2
    displayName: 'Analyze Load Test Results'
    inputs:
      targetType: 'inline'
      script: |
        $results = Get-Content "load-test-results.json" -Raw | ConvertFrom-Json -ErrorAction SilentlyContinue

        if ($results) {
          $metrics = $results.metrics

          Write-Host "========================================"
          Write-Host "Load Test Results Summary"
          Write-Host "========================================"
          Write-Host "Total Requests: $($metrics.http_reqs.count)"
          Write-Host "Request Rate: $($metrics.http_reqs.rate)/s"
          Write-Host "Error Rate: $([math]::Round($metrics.http_req_failed.rate * 100, 2))%"
          Write-Host ""
          Write-Host "Latency Metrics:"
          Write-Host "  Average: $([math]::Round($metrics.http_req_duration.avg, 2))ms"
          Write-Host "  P50: $([math]::Round($metrics.http_req_duration.'p(50)', 2))ms"
          Write-Host "  P90: $([math]::Round($metrics.http_req_duration.'p(90)', 2))ms"
          Write-Host "  P95: $([math]::Round($metrics.http_req_duration.'p(95)', 2))ms"
          Write-Host "  P99: $([math]::Round($metrics.http_req_duration.'p(99)', 2))ms"
          Write-Host "========================================"

          # Check thresholds
          $p95 = $metrics.http_req_duration.'p(95)'
          $errorRate = $metrics.http_req_failed.rate

          if ($p95 -gt 500) {
            Write-Host "##vso[task.logissue type=warning]P95 latency ($p95 ms) exceeds 500ms threshold"
          }

          if ($errorRate -gt 0.01) {
            Write-Host "##vso[task.logissue type=error]Error rate ($([math]::Round($errorRate * 100, 2))%) exceeds 1% threshold"
          }
        }

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Load Test Reports'
    inputs:
      PathtoPublish: '.'
      ArtifactName: 'load-test-reports-${{ parameters.serviceName }}-${{ parameters.environment }}'
      includePattern: '**/*load-test*'
    condition: always()
