# =============================================================================
# TERRAFORM DESTROY TEMPLATE
# =============================================================================
# Destroys Terraform-managed infrastructure for an environment
# WARNING: This is a destructive operation!
# =============================================================================

parameters:
  - name: workingDirectory
    type: string
    default: '$(System.DefaultWorkingDirectory)/infrastructure/terraform'

  - name: azureServiceConnection
    type: string

  - name: environment
    type: string
    default: 'dev'

  - name: additionalArgs
    type: string
    default: ''

steps:
  - script: |
      echo "##[warning]=========================================="
      echo "##[warning]TERRAFORM DESTROY - ${{ parameters.environment }}"
      echo "##[warning]=========================================="
      echo "##[warning]This will PERMANENTLY DELETE all resources!"
      echo "##[warning]Environment: ${{ parameters.environment }}"
      echo "##[warning]=========================================="
    displayName: 'Destroy Warning'

  - task: AzureCLI@2
    displayName: 'List Resources to Destroy'
    inputs:
      azureSubscription: '${{ parameters.azureServiceConnection }}'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      workingDirectory: '${{ parameters.workingDirectory }}'
      addSpnToEnvironment: true
      inlineScript: |
        # Export ARM credentials for Terraform
        export ARM_CLIENT_ID=$servicePrincipalId
        export ARM_CLIENT_SECRET=$servicePrincipalKey
        export ARM_TENANT_ID=$tenantId
        export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)

        echo "=========================================="
        echo "RESOURCES TO BE DESTROYED"
        echo "=========================================="

        terraform state list 2>/dev/null || echo "No resources found in state"

  - task: AzureCLI@2
    displayName: 'Terraform Destroy - ${{ parameters.environment }}'
    inputs:
      azureSubscription: '${{ parameters.azureServiceConnection }}'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      workingDirectory: '${{ parameters.workingDirectory }}'
      addSpnToEnvironment: true
      inlineScript: |
        set -e

        echo "=========================================="
        echo "EXECUTING TERRAFORM DESTROY"
        echo "Environment: ${{ parameters.environment }}"
        echo "Started: $(date)"
        echo "=========================================="

        # Export ARM credentials for Terraform
        export ARM_CLIENT_ID=$servicePrincipalId
        export ARM_CLIENT_SECRET=$servicePrincipalKey
        export ARM_TENANT_ID=$tenantId
        export ARM_SUBSCRIPTION_ID=$(az account show --query id -o tsv)

        # Check if environment-specific tfvars exists
        TFVARS_FILE="environments/${{ parameters.environment }}.tfvars"
        if [ -f "$TFVARS_FILE" ]; then
          echo "Using tfvars file: $TFVARS_FILE"
          VAR_FILE_ARG="-var-file=$TFVARS_FILE"
        else
          echo "No tfvars file found, using default with environment variable"
          VAR_FILE_ARG="-var=environment=${{ parameters.environment }}"
        fi

        # Block production destroy by default
        if [ "${{ parameters.environment }}" = "prod" ] || [ "${{ parameters.environment }}" = "live" ]; then
          echo "##[error]=========================================="
          echo "##[error]PRODUCTION DESTROY BLOCKED"
          echo "##[error]=========================================="
          echo "##[error]Destroying production/live environments requires"
          echo "##[error]manual intervention. Please destroy resources"
          echo "##[error]manually through Azure Portal or CLI."
          echo "##[error]=========================================="
          exit 1
        fi

        # Run destroy
        terraform destroy \
          $VAR_FILE_ARG \
          -auto-approve \
          -input=false \
          -no-color \
          ${{ parameters.additionalArgs }}

        echo ""
        echo "=========================================="
        echo "DESTROY COMPLETED"
        echo "Finished: $(date)"
        echo "=========================================="

  - script: |
      echo "##[warning]=========================================="
      echo "##[warning]DESTROY COMPLETED"
      echo "##[warning]=========================================="
      echo "##[warning]All resources for ${{ parameters.environment }} have been destroyed."
      echo "##[warning]Note: Some resources may have soft-delete enabled:"
      echo "##[warning]- Key Vault: Check soft-deleted vaults"
      echo "##[warning]- ACR: Check deleted registries"
      echo "##[warning]=========================================="
    displayName: 'Destroy Summary'
