# =============================================================================
# KUBERNETES HEALTH CHECK TEMPLATE
# =============================================================================
# Verify deployment health and run smoke tests
# =============================================================================

parameters:
  - name: kubernetesServiceConnection
    type: string
  - name: namespace
    type: string
  - name: services
    type: object
    default:
      - backend-gateway
      - auth-service
      - realtime-service
  - name: healthEndpoint
    type: string
    default: '/health'
  - name: timeout
    type: number
    default: 300

steps:
  # Check pod status
  - task: Kubernetes@1
    displayName: 'Check Pod Status'
    inputs:
      connectionType: 'Kubernetes Service Connection'
      kubernetesServiceEndpoint: '${{ parameters.kubernetesServiceConnection }}'
      namespace: '${{ parameters.namespace }}'
      command: 'get'
      arguments: 'pods -o wide --show-labels'
      outputFormat: 'yaml'

  # Check for crashed pods
  - bash: |
      echo "=== Checking for unhealthy pods ==="

      # Get pods not in Running state
      UNHEALTHY=$(kubectl get pods -n ${{ parameters.namespace }} \
        --field-selector=status.phase!=Running,status.phase!=Succeeded \
        -o name 2>/dev/null || true)

      if [ -n "$UNHEALTHY" ]; then
        echo "WARNING: Found unhealthy pods:"
        echo "$UNHEALTHY"

        # Get logs from unhealthy pods
        for pod in $UNHEALTHY; do
          echo "=== Logs from $pod ==="
          kubectl logs $pod -n ${{ parameters.namespace }} --tail=50 2>/dev/null || true
        done

        exit 1
      else
        echo "All pods are healthy"
      fi
    displayName: 'Check for Unhealthy Pods'
    env:
      KUBECONFIG: $(KUBECONFIG)

  # Check deployments are ready
  - task: Kubernetes@1
    displayName: 'Check Deployment Status'
    inputs:
      connectionType: 'Kubernetes Service Connection'
      kubernetesServiceEndpoint: '${{ parameters.kubernetesServiceConnection }}'
      namespace: '${{ parameters.namespace }}'
      command: 'get'
      arguments: 'deployments -o wide'

  # Check services have endpoints
  - task: Kubernetes@1
    displayName: 'Check Service Endpoints'
    inputs:
      connectionType: 'Kubernetes Service Connection'
      kubernetesServiceEndpoint: '${{ parameters.kubernetesServiceConnection }}'
      namespace: '${{ parameters.namespace }}'
      command: 'get'
      arguments: 'endpoints'

  # Run health checks against services
  - ${{ each service in parameters.services }}:
    - bash: |
        echo "=== Health check for ${{ service }} ==="

        # Port-forward to service
        kubectl port-forward svc/${{ service }} 8888:80 -n ${{ parameters.namespace }} &
        PF_PID=$!
        sleep 5

        # Check health endpoint
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8888${{ parameters.healthEndpoint }} || echo "000")

        # Kill port-forward
        kill $PF_PID 2>/dev/null || true

        if [ "$HTTP_CODE" = "200" ]; then
          echo "${{ service }} is healthy (HTTP $HTTP_CODE)"
        else
          echo "WARNING: ${{ service }} health check returned HTTP $HTTP_CODE"
        fi
      displayName: 'Health Check - ${{ service }}'
      continueOnError: true
      env:
        KUBECONFIG: $(KUBECONFIG)

  # Check HPA status
  - task: Kubernetes@1
    displayName: 'Check HPA Status'
    inputs:
      connectionType: 'Kubernetes Service Connection'
      kubernetesServiceEndpoint: '${{ parameters.kubernetesServiceConnection }}'
      namespace: '${{ parameters.namespace }}'
      command: 'get'
      arguments: 'hpa -o wide'

  # Check PDB status
  - task: Kubernetes@1
    displayName: 'Check PDB Status'
    inputs:
      connectionType: 'Kubernetes Service Connection'
      kubernetesServiceEndpoint: '${{ parameters.kubernetesServiceConnection }}'
      namespace: '${{ parameters.namespace }}'
      command: 'get'
      arguments: 'pdb'

  # Check recent events
  - task: Kubernetes@1
    displayName: 'Check Recent Events'
    inputs:
      connectionType: 'Kubernetes Service Connection'
      kubernetesServiceEndpoint: '${{ parameters.kubernetesServiceConnection }}'
      namespace: '${{ parameters.namespace }}'
      command: 'get'
      arguments: 'events --sort-by=.lastTimestamp --field-selector type!=Normal'
    continueOnError: true

  # Summary
  - bash: |
      echo "=== Health Check Summary ==="
      echo "Namespace: ${{ parameters.namespace }}"
      echo "Services checked: ${{ join(',', parameters.services) }}"
      echo "Health endpoint: ${{ parameters.healthEndpoint }}"
      echo "============================"
    displayName: 'Health Check Summary'
