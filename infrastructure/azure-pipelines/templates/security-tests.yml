# Security Tests Template
# Security scanning and vulnerability assessment

parameters:
  - name: environment
    type: string
  - name: serviceName
    type: string

steps:
  - checkout: self
    displayName: 'Checkout Repository'

  - task: AzureCLI@2
    displayName: 'Run OWASP ZAP Scan'
    inputs:
      azureSubscription: 'QuikApp-${{ parameters.environment }}'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        BASE_URL="https://${{ parameters.serviceName }}.${{ parameters.environment }}.quikapp.io"

        echo "Running OWASP ZAP scan against: $BASE_URL"

        # Pull and run ZAP
        docker pull owasp/zap2docker-stable

        # Run baseline scan
        docker run -v $(pwd)/reports:/zap/wrk:rw \
          -t owasp/zap2docker-stable zap-baseline.py \
          -t $BASE_URL \
          -r zap-report.html \
          -J zap-report.json \
          -I || true

  - task: AzureCLI@2
    displayName: 'Run Trivy Container Scan'
    inputs:
      azureSubscription: 'QuikApp-${{ parameters.environment }}'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "Running Trivy container vulnerability scan..."

        # Install Trivy
        curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

        # Scan container image
        trivy image \
          --severity HIGH,CRITICAL \
          --format json \
          --output trivy-results.json \
          $(acrRegistry)/${{ parameters.serviceName }}:$(imageTag) || true

  - task: AzureCLI@2
    displayName: 'Run Secret Scanning'
    inputs:
      azureSubscription: 'QuikApp-${{ parameters.environment }}'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "Running secret scanning with Gitleaks..."

        # Install Gitleaks
        curl -sSL https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz | tar xz

        # Run scan
        ./gitleaks detect --source . --report-format json --report-path gitleaks-report.json || true

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Security Reports'
    inputs:
      PathtoPublish: 'reports'
      ArtifactName: 'security-reports-${{ parameters.serviceName }}'
    condition: always()

  - task: PowerShell@2
    displayName: 'Analyze Security Results'
    inputs:
      targetType: 'inline'
      script: |
        $zapReport = Get-Content "reports/zap-report.json" -Raw | ConvertFrom-Json -ErrorAction SilentlyContinue
        $trivyReport = Get-Content "trivy-results.json" -Raw | ConvertFrom-Json -ErrorAction SilentlyContinue

        $highVulns = 0
        $criticalVulns = 0

        if ($trivyReport) {
          foreach ($result in $trivyReport.Results) {
            foreach ($vuln in $result.Vulnerabilities) {
              if ($vuln.Severity -eq "HIGH") { $highVulns++ }
              if ($vuln.Severity -eq "CRITICAL") { $criticalVulns++ }
            }
          }
        }

        Write-Host "Security Scan Summary:"
        Write-Host "  Critical Vulnerabilities: $criticalVulns"
        Write-Host "  High Vulnerabilities: $highVulns"

        if ($criticalVulns -gt 0) {
          Write-Host "##vso[task.logissue type=error]Found $criticalVulns critical vulnerabilities"
          Write-Host "##vso[task.complete result=SucceededWithIssues;]Security scan completed with critical findings"
        }
