# =============================================================================
# DOCKER BUILD TEMPLATE - PYTHON
# =============================================================================
# Build and push Python/FastAPI service Docker images
# =============================================================================

parameters:
  - name: serviceName
    type: string
  - name: serviceDir
    type: string
  - name: imageTag
    type: string
  - name: acrLoginServer
    type: string
  - name: pushImage
    type: boolean
    default: true
  - name: scanImage
    type: boolean
    default: true
  - name: pythonVersion
    type: string
    default: '3.11'
  - name: condition
    type: string
    default: 'true'

steps:
  - bash: |
      echo "=== Building Python Service ==="
      echo "Service: ${{ parameters.serviceName }}"
      echo "Directory: ${{ parameters.serviceDir }}"
      echo "Tag: ${{ parameters.imageTag }}"
      echo "Python Version: ${{ parameters.pythonVersion }}"
      echo "==============================="
    displayName: 'Display Build Info'
    condition: ${{ parameters.condition }}

  # Setup Python
  - task: UsePythonVersion@0
    displayName: 'Setup Python ${{ parameters.pythonVersion }}'
    condition: ${{ parameters.condition }}
    inputs:
      versionSpec: '${{ parameters.pythonVersion }}'

  # Cache pip dependencies
  - task: Cache@2
    displayName: 'Cache pip Dependencies'
    condition: ${{ parameters.condition }}
    inputs:
      key: 'pip | "$(Agent.OS)" | ${{ parameters.serviceDir }}/requirements.txt'
      restoreKeys: |
        pip | "$(Agent.OS)"
      path: $(PIP_CACHE_DIR)

  # Install dependencies
  - bash: |
      cd ${{ parameters.serviceDir }}
      python -m pip install --upgrade pip
      pip install -r requirements.txt
      pip install -r requirements-dev.txt 2>/dev/null || true
    displayName: 'Install Dependencies'
    condition: ${{ parameters.condition }}

  # Lint with ruff/flake8
  - bash: |
      cd ${{ parameters.serviceDir }}
      pip install ruff
      ruff check . || true
    displayName: 'Lint Code'
    condition: ${{ parameters.condition }}
    continueOnError: true

  # Type checking with mypy
  - bash: |
      cd ${{ parameters.serviceDir }}
      pip install mypy
      mypy . --ignore-missing-imports || true
    displayName: 'Type Check'
    condition: ${{ parameters.condition }}
    continueOnError: true

  # Run tests
  - bash: |
      cd ${{ parameters.serviceDir }}
      pip install pytest pytest-cov pytest-asyncio
      pytest -v --cov=. --cov-report=xml --cov-report=term-missing || true
    displayName: 'Run Unit Tests'
    condition: ${{ parameters.condition }}
    continueOnError: true

  # Login to ACR
  - task: Docker@2
    displayName: 'Login to ACR'
    condition: and(${{ parameters.condition }}, ${{ parameters.pushImage }})
    inputs:
      containerRegistry: 'quikapp-acr-connection'
      command: 'login'

  # Build Docker image
  - bash: |
      cd ${{ parameters.serviceDir }}

      # Check for custom Dockerfile
      if [ -f "Dockerfile" ]; then
        DOCKERFILE="Dockerfile"
      else
        DOCKERFILE="$(System.DefaultWorkingDirectory)/infrastructure/docker/dockerfiles/python/Dockerfile"
      fi

      docker build \
        -t ${{ parameters.acrLoginServer }}/${{ parameters.serviceName }}:${{ parameters.imageTag }} \
        -t ${{ parameters.acrLoginServer }}/${{ parameters.serviceName }}:$(Build.BuildId) \
        --build-arg PYTHON_VERSION=${{ parameters.pythonVersion }} \
        --label "org.opencontainers.image.source=$(Build.Repository.Uri)" \
        --label "org.opencontainers.image.revision=$(Build.SourceVersion)" \
        --label "org.opencontainers.image.created=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
        --label "com.quikapp.service=${{ parameters.serviceName }}" \
        --label "com.quikapp.technology=python" \
        -f $DOCKERFILE \
        .

      echo "Image built: ${{ parameters.acrLoginServer }}/${{ parameters.serviceName }}:${{ parameters.imageTag }}"
    displayName: 'Build Docker Image'
    condition: ${{ parameters.condition }}

  # Security scan with Trivy
  - bash: |
      # Install Trivy
      wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
      echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
      sudo apt-get update && sudo apt-get install -y trivy

      # Scan image
      trivy image \
        --exit-code 0 \
        --severity HIGH,CRITICAL \
        --format table \
        ${{ parameters.acrLoginServer }}/${{ parameters.serviceName }}:${{ parameters.imageTag }}

      # Generate SARIF report
      trivy image \
        --format sarif \
        --output $(Build.ArtifactStagingDirectory)/${{ parameters.serviceName }}-trivy.sarif \
        ${{ parameters.acrLoginServer }}/${{ parameters.serviceName }}:${{ parameters.imageTag }}
    displayName: 'Security Scan'
    condition: and(${{ parameters.condition }}, ${{ parameters.scanImage }})
    continueOnError: true

  # Push to ACR
  - bash: |
      docker push ${{ parameters.acrLoginServer }}/${{ parameters.serviceName }}:${{ parameters.imageTag }}
      docker push ${{ parameters.acrLoginServer }}/${{ parameters.serviceName }}:$(Build.BuildId)

      echo "Pushed: ${{ parameters.acrLoginServer }}/${{ parameters.serviceName }}:${{ parameters.imageTag }}"
    displayName: 'Push to ACR'
    condition: and(${{ parameters.condition }}, ${{ parameters.pushImage }})

  # Publish test coverage
  - task: PublishCodeCoverageResults@1
    displayName: 'Publish Coverage'
    condition: ${{ parameters.condition }}
    inputs:
      codeCoverageTool: 'Cobertura'
      summaryFileLocation: '${{ parameters.serviceDir }}/coverage.xml'
    continueOnError: true

  # Publish scan results
  - publish: $(Build.ArtifactStagingDirectory)/${{ parameters.serviceName }}-trivy.sarif
    artifact: 'security-scan-${{ parameters.serviceName }}'
    displayName: 'Publish Security Report'
    condition: and(${{ parameters.condition }}, ${{ parameters.scanImage }})
    continueOnError: true
