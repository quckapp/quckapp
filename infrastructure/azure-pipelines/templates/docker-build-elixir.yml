# =============================================================================
# DOCKER BUILD TEMPLATE - ELIXIR
# =============================================================================
# Build and push Elixir/Phoenix service Docker images
# =============================================================================

parameters:
  - name: serviceName
    type: string
  - name: serviceDir
    type: string
  - name: imageTag
    type: string
  - name: acrLoginServer
    type: string
  - name: pushImage
    type: boolean
    default: true
  - name: scanImage
    type: boolean
    default: true
  - name: elixirVersion
    type: string
    default: '1.15'
  - name: otpVersion
    type: string
    default: '26'
  - name: condition
    type: string
    default: 'true'

steps:
  - bash: |
      echo "=== Building Elixir Service ==="
      echo "Service: ${{ parameters.serviceName }}"
      echo "Directory: ${{ parameters.serviceDir }}"
      echo "Tag: ${{ parameters.imageTag }}"
      echo "Elixir Version: ${{ parameters.elixirVersion }}"
      echo "OTP Version: ${{ parameters.otpVersion }}"
      echo "==============================="
    displayName: 'Display Build Info'
    condition: ${{ parameters.condition }}

  # Cache Hex/Mix dependencies
  - task: Cache@2
    displayName: 'Cache Mix Dependencies'
    condition: ${{ parameters.condition }}
    inputs:
      key: 'mix | "$(Agent.OS)" | ${{ parameters.serviceDir }}/mix.lock'
      restoreKeys: |
        mix | "$(Agent.OS)"
      path: |
        ${{ parameters.serviceDir }}/deps
        ${{ parameters.serviceDir }}/_build

  # Login to ACR
  - task: Docker@2
    displayName: 'Login to ACR'
    condition: and(${{ parameters.condition }}, ${{ parameters.pushImage }})
    inputs:
      containerRegistry: 'quikapp-acr-connection'
      command: 'login'

  # Build Docker image (multi-stage build handles compilation)
  - bash: |
      cd ${{ parameters.serviceDir }}

      # Check for custom Dockerfile
      if [ -f "Dockerfile" ]; then
        DOCKERFILE="Dockerfile"
      else
        DOCKERFILE="$(System.DefaultWorkingDirectory)/infrastructure/docker/dockerfiles/elixir/Dockerfile"
      fi

      docker build \
        -t ${{ parameters.acrLoginServer }}/${{ parameters.serviceName }}:${{ parameters.imageTag }} \
        -t ${{ parameters.acrLoginServer }}/${{ parameters.serviceName }}:$(Build.BuildId) \
        --build-arg ELIXIR_VERSION=${{ parameters.elixirVersion }} \
        --build-arg OTP_VERSION=${{ parameters.otpVersion }} \
        --build-arg MIX_ENV=prod \
        --build-arg APP_NAME=${{ parameters.serviceName }} \
        --label "org.opencontainers.image.source=$(Build.Repository.Uri)" \
        --label "org.opencontainers.image.revision=$(Build.SourceVersion)" \
        --label "org.opencontainers.image.created=$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
        --label "com.quikapp.service=${{ parameters.serviceName }}" \
        --label "com.quikapp.technology=elixir" \
        -f $DOCKERFILE \
        .

      echo "Image built: ${{ parameters.acrLoginServer }}/${{ parameters.serviceName }}:${{ parameters.imageTag }}"
    displayName: 'Build Docker Image'
    condition: ${{ parameters.condition }}

  # Security scan with Trivy
  - bash: |
      # Install Trivy
      wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
      echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
      sudo apt-get update && sudo apt-get install -y trivy

      # Scan image
      trivy image \
        --exit-code 0 \
        --severity HIGH,CRITICAL \
        --format table \
        ${{ parameters.acrLoginServer }}/${{ parameters.serviceName }}:${{ parameters.imageTag }}

      # Generate SARIF report
      trivy image \
        --format sarif \
        --output $(Build.ArtifactStagingDirectory)/${{ parameters.serviceName }}-trivy.sarif \
        ${{ parameters.acrLoginServer }}/${{ parameters.serviceName }}:${{ parameters.imageTag }}
    displayName: 'Security Scan'
    condition: and(${{ parameters.condition }}, ${{ parameters.scanImage }})
    continueOnError: true

  # Push to ACR
  - bash: |
      docker push ${{ parameters.acrLoginServer }}/${{ parameters.serviceName }}:${{ parameters.imageTag }}
      docker push ${{ parameters.acrLoginServer }}/${{ parameters.serviceName }}:$(Build.BuildId)

      echo "Pushed: ${{ parameters.acrLoginServer }}/${{ parameters.serviceName }}:${{ parameters.imageTag }}"
    displayName: 'Push to ACR'
    condition: and(${{ parameters.condition }}, ${{ parameters.pushImage }})

  # Publish scan results
  - publish: $(Build.ArtifactStagingDirectory)/${{ parameters.serviceName }}-trivy.sarif
    artifact: 'security-scan-${{ parameters.serviceName }}'
    displayName: 'Publish Security Report'
    condition: and(${{ parameters.condition }}, ${{ parameters.scanImage }})
    continueOnError: true
