# =============================================================================
# PYTHON SERVICES - ANALYTICS & ML
# =============================================================================
# analytics-service, ml-service, moderation-service, sentiment-service
# =============================================================================

# =============================================================================
# ANALYTICS SERVICE (FastAPI)
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: analytics-service
  namespace: quikapp
  labels:
    app.kubernetes.io/name: analytics-service
    app.kubernetes.io/component: analytics
    app.kubernetes.io/part-of: quikapp
    app.kubernetes.io/technology: python
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: analytics-service
  template:
    metadata:
      labels:
        app.kubernetes.io/name: analytics-service
        app.kubernetes.io/component: analytics
        app.kubernetes.io/part-of: quikapp
        app.kubernetes.io/technology: python
        app.kubernetes.io/uses-broker: "true"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8000"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: quikapp-worker-sa
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
      containers:
        - name: analytics-service
          image: quikapp.azurecr.io/analytics-service:latest
          ports:
            - name: http
              containerPort: 8000
          env:
            - name: ENVIRONMENT
              valueFrom:
                configMapKeyRef:
                  name: quikapp-common-config
                  key: ENVIRONMENT
            - name: PORT
              value: "8000"
            - name: WORKERS
              value: "4"
            # Database
            - name: POSTGRES_HOST
              valueFrom:
                configMapKeyRef:
                  name: quikapp-database-config
                  key: POSTGRES_HOST
            - name: POSTGRES_PORT
              valueFrom:
                configMapKeyRef:
                  name: quikapp-database-config
                  key: POSTGRES_PORT
            - name: POSTGRES_DB
              value: "quikapp_analytics"
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: quikapp-database-secrets
                  key: POSTGRES_USERNAME
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: quikapp-database-secrets
                  key: POSTGRES_PASSWORD
            # Redis
            - name: REDIS_HOST
              valueFrom:
                configMapKeyRef:
                  name: quikapp-database-config
                  key: REDIS_HOST
            - name: REDIS_PORT
              valueFrom:
                configMapKeyRef:
                  name: quikapp-database-config
                  key: REDIS_PORT
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: quikapp-database-secrets
                  key: REDIS_PASSWORD
            # Kafka
            - name: KAFKA_BROKERS
              valueFrom:
                configMapKeyRef:
                  name: quikapp-broker-config
                  key: KAFKA_BROKERS
            # ClickHouse for analytics storage
            - name: CLICKHOUSE_HOST
              valueFrom:
                configMapKeyRef:
                  name: quikapp-database-config
                  key: CLICKHOUSE_HOST
            - name: CLICKHOUSE_PORT
              value: "9000"
            # Monitoring
            - name: OTEL_SERVICE_NAME
              value: "analytics-service"
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              valueFrom:
                configMapKeyRef:
                  name: quikapp-monitoring-config
                  key: OTEL_EXPORTER_OTLP_ENDPOINT
          resources:
            requests:
              cpu: "200m"
              memory: "512Mi"
            limits:
              cpu: "1000m"
              memory: "1Gi"
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health/ready
              port: http
            initialDelaySeconds: 15
            periodSeconds: 5
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]
          volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: cache
              mountPath: /app/.cache
      volumes:
        - name: tmp
          emptyDir: {}
        - name: cache
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: analytics-service
  namespace: quikapp
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: http
  selector:
    app.kubernetes.io/name: analytics-service
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: analytics-service-hpa
  namespace: quikapp
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: analytics-service
  minReplicas: 2
  maxReplicas: 8
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
---
# =============================================================================
# ML SERVICE (FastAPI + ML Models)
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ml-service
  namespace: quikapp
  labels:
    app.kubernetes.io/name: ml-service
    app.kubernetes.io/component: ml
    app.kubernetes.io/part-of: quikapp
    app.kubernetes.io/technology: python
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: ml-service
  template:
    metadata:
      labels:
        app.kubernetes.io/name: ml-service
        app.kubernetes.io/component: ml
        app.kubernetes.io/part-of: quikapp
        app.kubernetes.io/technology: python
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8000"
    spec:
      serviceAccountName: quikapp-worker-sa
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
      containers:
        - name: ml-service
          image: quikapp.azurecr.io/ml-service:latest
          ports:
            - name: http
              containerPort: 8000
            - name: grpc
              containerPort: 50051
          env:
            - name: ENVIRONMENT
              valueFrom:
                configMapKeyRef:
                  name: quikapp-common-config
                  key: ENVIRONMENT
            - name: PORT
              value: "8000"
            - name: GRPC_PORT
              value: "50051"
            - name: WORKERS
              value: "2"
            # Redis for caching predictions
            - name: REDIS_HOST
              valueFrom:
                configMapKeyRef:
                  name: quikapp-database-config
                  key: REDIS_HOST
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: quikapp-database-secrets
                  key: REDIS_PASSWORD
            # Model storage
            - name: AZURE_STORAGE_CONNECTION_STRING
              valueFrom:
                secretKeyRef:
                  name: quikapp-storage-secrets
                  key: AZURE_STORAGE_CONNECTION_STRING
            - name: MODEL_CONTAINER
              value: "ml-models"
            # ML Config
            - name: MODEL_CACHE_DIR
              value: "/app/models"
            - name: BATCH_SIZE
              value: "32"
            - name: MAX_SEQUENCE_LENGTH
              value: "512"
            # Monitoring
            - name: OTEL_SERVICE_NAME
              value: "ml-service"
          resources:
            requests:
              cpu: "500m"
              memory: "1Gi"
            limits:
              cpu: "2000m"
              memory: "4Gi"
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 60
            periodSeconds: 15
          readinessProbe:
            httpGet:
              path: /health/ready
              port: http
            initialDelaySeconds: 45
            periodSeconds: 10
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]
          volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: models
              mountPath: /app/models
            - name: cache
              mountPath: /app/.cache
      volumes:
        - name: tmp
          emptyDir: {}
        - name: models
          emptyDir:
            sizeLimit: 5Gi
        - name: cache
          emptyDir: {}
      # Prefer nodes with more memory for ML workloads
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: workload-type
                    operator: In
                    values:
                      - ml
                      - compute
---
apiVersion: v1
kind: Service
metadata:
  name: ml-service
  namespace: quikapp
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: http
    - name: grpc
      port: 50051
      targetPort: grpc
  selector:
    app.kubernetes.io/name: ml-service
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: ml-service-hpa
  namespace: quikapp
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: ml-service
  minReplicas: 2
  maxReplicas: 6
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 60
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 75
---
# =============================================================================
# MODERATION SERVICE (FastAPI + Content Moderation)
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: moderation-service
  namespace: quikapp
  labels:
    app.kubernetes.io/name: moderation-service
    app.kubernetes.io/component: moderation
    app.kubernetes.io/part-of: quikapp
    app.kubernetes.io/technology: python
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: moderation-service
  template:
    metadata:
      labels:
        app.kubernetes.io/name: moderation-service
        app.kubernetes.io/component: moderation
        app.kubernetes.io/part-of: quikapp
        app.kubernetes.io/technology: python
        app.kubernetes.io/uses-broker: "true"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8000"
    spec:
      serviceAccountName: quikapp-worker-sa
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
      containers:
        - name: moderation-service
          image: quikapp.azurecr.io/moderation-service:latest
          ports:
            - name: http
              containerPort: 8000
          env:
            - name: ENVIRONMENT
              valueFrom:
                configMapKeyRef:
                  name: quikapp-common-config
                  key: ENVIRONMENT
            - name: PORT
              value: "8000"
            - name: WORKERS
              value: "4"
            # Kafka for async processing
            - name: KAFKA_BROKERS
              valueFrom:
                configMapKeyRef:
                  name: quikapp-broker-config
                  key: KAFKA_BROKERS
            - name: KAFKA_CONSUMER_GROUP
              value: "moderation-service"
            # Redis
            - name: REDIS_HOST
              valueFrom:
                configMapKeyRef:
                  name: quikapp-database-config
                  key: REDIS_HOST
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: quikapp-database-secrets
                  key: REDIS_PASSWORD
            # ML Service for model inference
            - name: ML_SERVICE_URL
              value: "http://ml-service.quikapp.svc.cluster.local"
            - name: ML_SERVICE_GRPC
              value: "ml-service.quikapp.svc.cluster.local:50051"
            # External moderation APIs (Azure Content Safety)
            - name: AZURE_CONTENT_SAFETY_ENDPOINT
              valueFrom:
                secretKeyRef:
                  name: quikapp-external-secrets
                  key: AZURE_CONTENT_SAFETY_ENDPOINT
            - name: AZURE_CONTENT_SAFETY_KEY
              valueFrom:
                secretKeyRef:
                  name: quikapp-external-secrets
                  key: AZURE_CONTENT_SAFETY_KEY
            # Moderation config
            - name: TOXICITY_THRESHOLD
              value: "0.7"
            - name: SPAM_THRESHOLD
              value: "0.8"
            - name: AUTO_ACTION_THRESHOLD
              value: "0.95"
            # Monitoring
            - name: OTEL_SERVICE_NAME
              value: "moderation-service"
          resources:
            requests:
              cpu: "200m"
              memory: "512Mi"
            limits:
              cpu: "1000m"
              memory: "1Gi"
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health/ready
              port: http
            initialDelaySeconds: 15
            periodSeconds: 5
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]
          volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: cache
              mountPath: /app/.cache
      volumes:
        - name: tmp
          emptyDir: {}
        - name: cache
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: moderation-service
  namespace: quikapp
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: http
  selector:
    app.kubernetes.io/name: moderation-service
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: moderation-service-hpa
  namespace: quikapp
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: moderation-service
  minReplicas: 2
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 65
---
# =============================================================================
# SENTIMENT SERVICE (FastAPI + NLP)
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: sentiment-service
  namespace: quikapp
  labels:
    app.kubernetes.io/name: sentiment-service
    app.kubernetes.io/component: nlp
    app.kubernetes.io/part-of: quikapp
    app.kubernetes.io/technology: python
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: sentiment-service
  template:
    metadata:
      labels:
        app.kubernetes.io/name: sentiment-service
        app.kubernetes.io/component: nlp
        app.kubernetes.io/part-of: quikapp
        app.kubernetes.io/technology: python
        app.kubernetes.io/uses-broker: "true"
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8000"
    spec:
      serviceAccountName: quikapp-worker-sa
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
      containers:
        - name: sentiment-service
          image: quikapp.azurecr.io/sentiment-service:latest
          ports:
            - name: http
              containerPort: 8000
          env:
            - name: ENVIRONMENT
              valueFrom:
                configMapKeyRef:
                  name: quikapp-common-config
                  key: ENVIRONMENT
            - name: PORT
              value: "8000"
            - name: WORKERS
              value: "2"
            # Kafka
            - name: KAFKA_BROKERS
              valueFrom:
                configMapKeyRef:
                  name: quikapp-broker-config
                  key: KAFKA_BROKERS
            - name: KAFKA_CONSUMER_GROUP
              value: "sentiment-service"
            # Redis for caching
            - name: REDIS_HOST
              valueFrom:
                configMapKeyRef:
                  name: quikapp-database-config
                  key: REDIS_HOST
            - name: REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: quikapp-database-secrets
                  key: REDIS_PASSWORD
            # Model config
            - name: MODEL_NAME
              value: "distilbert-base-uncased-finetuned-sst-2-english"
            - name: MODEL_CACHE_DIR
              value: "/app/models"
            - name: BATCH_SIZE
              value: "16"
            # Analytics integration
            - name: ANALYTICS_SERVICE_URL
              value: "http://analytics-service.quikapp.svc.cluster.local"
            # Monitoring
            - name: OTEL_SERVICE_NAME
              value: "sentiment-service"
          resources:
            requests:
              cpu: "300m"
              memory: "768Mi"
            limits:
              cpu: "1500m"
              memory: "2Gi"
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 45
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health/ready
              port: http
            initialDelaySeconds: 30
            periodSeconds: 5
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]
          volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: models
              mountPath: /app/models
            - name: cache
              mountPath: /app/.cache
      volumes:
        - name: tmp
          emptyDir: {}
        - name: models
          emptyDir:
            sizeLimit: 2Gi
        - name: cache
          emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: sentiment-service
  namespace: quikapp
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 80
      targetPort: http
  selector:
    app.kubernetes.io/name: sentiment-service
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: sentiment-service-hpa
  namespace: quikapp
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: sentiment-service
  minReplicas: 2
  maxReplicas: 8
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 65
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
---
# =============================================================================
# PDB FOR PYTHON SERVICES
# =============================================================================
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: analytics-service-pdb
  namespace: quikapp
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: analytics-service
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: ml-service-pdb
  namespace: quikapp
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: ml-service
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: moderation-service-pdb
  namespace: quikapp
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: moderation-service
