{{- if .Values.swaggerUi.enabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "quikapp.fullname" . }}-swagger-ui-config
  labels:
    {{- include "quikapp.labels" . | nindent 4 }}
    app.kubernetes.io/component: swagger-ui
data:
  swagger-initializer.js: |
    window.onload = function() {
      window.ui = SwaggerUIBundle({
        url: "/openapi.yaml",
        dom_id: '#swagger-ui',
        deepLinking: true,
        presets: [
          SwaggerUIBundle.presets.apis,
          SwaggerUIStandalonePreset
        ],
        plugins: [
          SwaggerUIBundle.plugins.DownloadUrl
        ],
        layout: "StandaloneLayout",
        validatorUrl: null,
        displayRequestDuration: true,
        filter: true,
        showExtensions: true,
        tryItOutEnabled: {{ .Values.swaggerUi.tryItOutEnabled }},
        persistAuthorization: true,
        docExpansion: "{{ .Values.swaggerUi.docExpansion }}",
        defaultModelsExpandDepth: {{ .Values.swaggerUi.defaultModelsExpandDepth }},
        syntaxHighlight: {
          activate: true,
          theme: "monokai"
        }
      });
    };
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "quikapp.fullname" . }}-swagger-ui
  labels:
    {{- include "quikapp.labels" . | nindent 4 }}
    app.kubernetes.io/component: swagger-ui
spec:
  replicas: {{ .Values.swaggerUi.replicas }}
  selector:
    matchLabels:
      {{- include "quikapp.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: swagger-ui
  template:
    metadata:
      labels:
        {{- include "quikapp.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: swagger-ui
    spec:
      containers:
        - name: swagger-ui
          image: "{{ .Values.swaggerUi.image.repository }}:{{ .Values.swaggerUi.image.tag }}"
          imagePullPolicy: {{ .Values.swaggerUi.image.pullPolicy }}
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          env:
            - name: SWAGGER_JSON
              value: /openapi/openapi.yaml
            - name: BASE_URL
              value: "{{ .Values.swaggerUi.basePath }}"
            - name: DEEP_LINKING
              value: "true"
            - name: DISPLAY_REQUEST_DURATION
              value: "true"
            - name: FILTER
              value: "true"
            - name: TRY_IT_OUT_ENABLED
              value: "{{ .Values.swaggerUi.tryItOutEnabled }}"
            - name: PERSIST_AUTHORIZATION
              value: "true"
            - name: VALIDATOR_URL
              value: "null"
            - name: DOC_EXPANSION
              value: "{{ .Values.swaggerUi.docExpansion }}"
          volumeMounts:
            - name: openapi-spec
              mountPath: /openapi
              readOnly: true
            - name: swagger-config
              mountPath: /usr/share/nginx/html/swagger-initializer.js
              subPath: swagger-initializer.js
          livenessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
          resources:
            {{- toYaml .Values.swaggerUi.resources | nindent 12 }}
      volumes:
        - name: openapi-spec
          configMap:
            name: {{ include "quikapp.fullname" . }}-openapi-spec
        - name: swagger-config
          configMap:
            name: {{ include "quikapp.fullname" . }}-swagger-ui-config
      {{- with .Values.swaggerUi.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "quikapp.fullname" . }}-swagger-ui
  labels:
    {{- include "quikapp.labels" . | nindent 4 }}
    app.kubernetes.io/component: swagger-ui
spec:
  type: {{ .Values.swaggerUi.service.type }}
  ports:
    - port: {{ .Values.swaggerUi.service.port }}
      targetPort: http
      protocol: TCP
      name: http
  selector:
    {{- include "quikapp.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: swagger-ui
{{- if .Values.swaggerUi.ingress.enabled }}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "quikapp.fullname" . }}-swagger-ui
  labels:
    {{- include "quikapp.labels" . | nindent 4 }}
    app.kubernetes.io/component: swagger-ui
  {{- with .Values.swaggerUi.ingress.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- if .Values.swaggerUi.ingress.className }}
  ingressClassName: {{ .Values.swaggerUi.ingress.className }}
  {{- end }}
  {{- if .Values.swaggerUi.ingress.tls }}
  tls:
    {{- range .Values.swaggerUi.ingress.tls }}
    - hosts:
        {{- range .hosts }}
        - {{ . | quote }}
        {{- end }}
      secretName: {{ .secretName }}
    {{- end }}
  {{- end }}
  rules:
    {{- range .Values.swaggerUi.ingress.hosts }}
    - host: {{ .host | quote }}
      http:
        paths:
          {{- range .paths }}
          - path: {{ .path }}
            pathType: {{ .pathType }}
            backend:
              service:
                name: {{ include "quikapp.fullname" $ }}-swagger-ui
                port:
                  number: {{ $.Values.swaggerUi.service.port }}
          {{- end }}
    {{- end }}
{{- end }}
{{- end }}
