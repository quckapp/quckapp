# S3 Module

Creates S3 buckets for media storage with encryption, lifecycle policies, and optional replication.

## Features

- Media bucket for photos, videos, voice messages, files
- Thumbnails bucket for processed images
- Logs bucket for access logging
- Server-side encryption with KMS
- Lifecycle policies for cost optimization
- Cross-region replication (optional)
- Intelligent-Tiering (optional)
- CORS configuration for web access
- Event notifications for processing

## Usage

```hcl
module "s3" {
  source = "../../modules/s3"

  environment = "prod"
  kms_key_arn = module.kms.s3_media_key_arn

  # CORS
  cors_allowed_origins = ["https://app.quikapp.com"]

  # Versioning
  enable_versioning = true

  # Lifecycle rules
  lifecycle_rules = {
    photos = {
      transition_to_ia_days      = 30
      transition_to_glacier_days = 90
      expiration_days            = 365
    }
    videos = {
      transition_to_ia_days      = 7
      transition_to_glacier_days = 30
      expiration_days            = 180
    }
  }

  # Replication (optional)
  enable_replication                 = true
  replication_destination_bucket_arn = "arn:aws:s3:::backup-bucket"

  tags = var.tags
}
```

## Bucket Structure

### Media Bucket

```
quikapp-{env}-media/
├── photos/
│   └── {user_id}/{year}/{month}/{file_id}.{ext}
├── videos/
│   └── {user_id}/{year}/{month}/{file_id}.{ext}
├── voice/
│   └── {user_id}/{year}/{month}/{file_id}.{ext}
└── files/
    └── {user_id}/{year}/{month}/{file_id}.{ext}
```

### Thumbnails Bucket

```
quikapp-{env}-thumbnails/
├── small/
│   └── {file_id}.webp
├── medium/
│   └── {file_id}.webp
└── large/
    └── {file_id}.webp
```

## Lifecycle Policies

### Default Transitions

| Media Type | IA Transition | Glacier | Expiration |
|------------|---------------|---------|------------|
| Photos | 30 days | 90 days | 365 days |
| Videos | 7 days | 30 days | 180 days |
| Voice | 7 days | - | 30 days |
| Files | 30 days | 90 days | Never |
| Thumbnails | - | - | 7 days |

### Noncurrent Version Handling

- Noncurrent versions expire after 30 days
- Incomplete multipart uploads abort after 7 days

## Encryption

All buckets use server-side encryption:

```hcl
# SSE-KMS with customer managed key
server_side_encryption_configuration {
  rule {
    apply_server_side_encryption_by_default {
      sse_algorithm     = "aws:kms"
      kms_master_key_id = var.kms_key_arn
    }
    bucket_key_enabled = true  # Reduces KMS costs
  }
}
```

## CORS Configuration

```hcl
cors_rule {
  allowed_headers = ["*"]
  allowed_methods = ["GET", "PUT", "POST", "DELETE", "HEAD"]
  allowed_origins = var.cors_allowed_origins
  expose_headers  = ["ETag", "x-amz-meta-*"]
  max_age_seconds = 3600
}
```

## Event Notifications

```hcl
# Trigger Lambda on new uploads
notification {
  lambda_function {
    lambda_function_arn = var.lambda_thumbnail_arn
    events              = ["s3:ObjectCreated:*"]
    filter_prefix       = "photos/"
  }
}

# Send to SQS for processing
notification {
  queue {
    queue_arn     = var.sqs_queue_arn
    events        = ["s3:ObjectCreated:*"]
    filter_prefix = "videos/"
  }
}
```

## Variables

| Name | Description | Type | Default |
|------|-------------|------|---------|
| `environment` | Environment name | string | - |
| `kms_key_arn` | KMS key for encryption | string | - |
| `cors_allowed_origins` | CORS origins | list(string) | `[]` |
| `enable_versioning` | Enable versioning | bool | `true` |
| `enable_replication` | Enable cross-region replication | bool | `false` |
| `enable_intelligent_tiering` | Enable Intelligent-Tiering | bool | `false` |

## Outputs

| Name | Description |
|------|-------------|
| `media_bucket_id` | Media bucket name |
| `media_bucket_arn` | Media bucket ARN |
| `thumbnails_bucket_id` | Thumbnails bucket name |
| `logs_bucket_id` | Logs bucket name |
| `bucket_names` | Map of all bucket names |
| `presigned_url_config` | Config for generating presigned URLs |

## Presigned URL Configuration

The module outputs configuration for generating presigned URLs:

```javascript
// JavaScript example
const config = terraform.output('presigned_url_config');

const params = {
  Bucket: config.bucket,
  Key: `photos/${userId}/${fileId}.jpg`,
  Expires: config.upload_expiration,
  ContentType: 'image/jpeg'
};

const uploadUrl = s3.getSignedUrl('putObject', params);
```

## Cost Optimization

| Storage Class | Use Case | Cost (GB/month) |
|--------------|----------|-----------------|
| Standard | Active data | $0.023 |
| IA | Infrequent access | $0.0125 |
| Glacier | Archive | $0.004 |
| Deep Archive | Long-term | $0.00099 |

### Tips

1. Use lifecycle policies aggressively
2. Enable Intelligent-Tiering for unpredictable access
3. Use S3 Bucket Keys to reduce KMS costs
4. Set appropriate expiration for temporary data
