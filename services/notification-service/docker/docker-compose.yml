version: '3.8'

services:
  # Notification Service API
  notification-service:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: quickchat-notification-service
    ports:
      - "8080:8080"
    environment:
      - NOTIFICATION_SERVER_PORT=8080
      - NOTIFICATION_SERVER_ENV=development
      - NOTIFICATION_LOGLEVEL=info
      # MySQL
      - NOTIFICATION_MYSQL_HOST=mysql
      - NOTIFICATION_MYSQL_PORT=3306
      - NOTIFICATION_MYSQL_USER=quickchat
      - NOTIFICATION_MYSQL_PASSWORD=quickchat_notification_password
      - NOTIFICATION_MYSQL_DATABASE=quickchat_notification
      # MongoDB
      - NOTIFICATION_MONGODB_URI=mongodb://mongodb:27017
      - NOTIFICATION_MONGODB_DATABASE=quickchat_notifications
      # Redis
      - NOTIFICATION_REDIS_HOST=redis
      - NOTIFICATION_REDIS_PORT=6379
      # Kafka
      - NOTIFICATION_KAFKA_BROKERS=kafka:9092
      - NOTIFICATION_KAFKA_TOPIC=notifications
      - NOTIFICATION_KAFKA_CONSUMERGROUP=notification-service
      # Firebase (optional)
      - NOTIFICATION_FIREBASE_CREDENTIALSFILE=/app/config/firebase-credentials.json
      # Email (optional)
      - NOTIFICATION_EMAIL_PROVIDER=sendgrid
      - NOTIFICATION_EMAIL_APIKEY=${SENDGRID_API_KEY:-}
      - NOTIFICATION_EMAIL_FROMEMAIL=noreply@quickchat.com
      - NOTIFICATION_EMAIL_FROMNAME=QuickChat
      # SMS (optional)
      - NOTIFICATION_SMS_PROVIDER=twilio
      - NOTIFICATION_SMS_ACCOUNTSID=${TWILIO_ACCOUNT_SID:-}
      - NOTIFICATION_SMS_AUTHTOKEN=${TWILIO_AUTH_TOKEN:-}
      - NOTIFICATION_SMS_FROMNUMBER=${TWILIO_FROM_NUMBER:-}
      # Worker settings
      - NOTIFICATION_WORKER_POOLSIZE=10
      - NOTIFICATION_WORKER_RETRYCOUNT=3
      - NOTIFICATION_WORKER_RETRYDELAY=60
    volumes:
      - ./config:/app/config:ro
    depends_on:
      mysql:
        condition: service_healthy
      mongodb:
        condition: service_started
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - quickchat-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # MySQL Database
  mysql:
    image: mysql:8.0
    container_name: quickchat-notification-mysql
    ports:
      - "3308:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=root_password
      - MYSQL_DATABASE=quickchat_notification
      - MYSQL_USER=quickchat
      - MYSQL_PASSWORD=quickchat_notification_password
    volumes:
      - mysql-data:/var/lib/mysql
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
      --default-authentication-plugin=mysql_native_password
    networks:
      - quickchat-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot_password"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # MongoDB
  mongodb:
    image: mongo:7
    container_name: quickchat-notification-mongodb
    ports:
      - "27019:27017"
    volumes:
      - mongodb-data:/data/db
    networks:
      - quickchat-network
    restart: unless-stopped

  # Redis
  redis:
    image: redis:7-alpine
    container_name: quickchat-notification-redis
    ports:
      - "6381:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes
    networks:
      - quickchat-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Kafka
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: quickchat-notification-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zookeeper-data:/var/lib/zookeeper/data
      - zookeeper-logs:/var/lib/zookeeper/log
    networks:
      - quickchat-network
    restart: unless-stopped

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: quickchat-notification-kafka
    ports:
      - "9093:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:9093
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    volumes:
      - kafka-data:/var/lib/kafka/data
    depends_on:
      - zookeeper
    networks:
      - quickchat-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  # Kafka UI (optional - for debugging)
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: quickchat-notification-kafka-ui
    ports:
      - "8081:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: quickchat
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
    depends_on:
      - kafka
    networks:
      - quickchat-network
    restart: unless-stopped

volumes:
  mysql-data:
  mongodb-data:
  redis-data:
  zookeeper-data:
  zookeeper-logs:
  kafka-data:

networks:
  quickchat-network:
    driver: bridge
    name: quickchat-notification-network
